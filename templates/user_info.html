<!-- Cropping css/js start 这个放在最上面 否则加载不到-->
{% from 'commons/upload.html' import macro_upload_js_css %}
{{ macro_upload_js_css() }}
<!-- Cropping css/js end -->
{% extends 'commons/_proto.html' %}
{% from 'commons/upload.html' import macro_upload %}
{% block head %}
{% endblock %}
{% block body %}
<div id="navbar" class="navbar_style">
    {% include 'commons/navbar_toutiao.html' %}
</div>
<div class="container" id="crop-avatar" style="width:90%">
    {% if user_info %}
    <div class="all_backgroud">
        <div class="user_info_wrap">
            <div id="user_face" class="user_info_face_div avatar-view">
                <a href="JavaScript:void(0)"><img class="comm-img-bg" src="{{user_info.head_img_url}}" alt="用户头像"></a>
            </div>
            <div id="user_name" class="user_info_name_div">
                <p class="user_info_name_p">{{user_info.name}}</p>
            </div>
            <div id="user_label" class="user_info_professional_div">
                <p class="user_info_professional_p">{{user_info.label}}</p>
            </div>
            <div>
                {% if user_info.id!=session.get('userinfo')['id'] %}
                <a class="user_btn user_sendmsg_btn" href="/private_message?to_user_id={{user_info.id}}">发私信</a>
                {%endif%}
            </div>
            <input id="type" name="text" value="user" type="hidden">
            {% if user_info.id ==session.get('userinfo')['id'] %}
            {{ macro_upload()}}
            {%endif%}

        </div>
    </div>
    <div id="user" class="col-sm-12 u_page_title"><a href="user_info?user_id={{user_info.id}}">个人主页</a></div>
    <div id="post_container" class="col-sm-12 no_m_p">
        <div class="user_post_wrap col-sm-8">
            <div class="col-sm-12 user_post"></div>
            <div class="page-center">
                <ul class="sync-pagination pagination-sm" id="user-post-pagination"></ul>
            </div>
        </div>
        <div class="user_friend_wrap">
            <div class="col-sm-12 f_title ">好友列表</div>
            <div class="col-sm-12 friend_content"></div>
            <!--<div class="page-center"><ul class="sync-pagination pagination-sm" id="friend-pagination"></ul></div>-->
        </div>
    </div>
    <div id="friend_container" class="col-sm-12 u_friend_container">
        <div class="col-sm-12 user_friend_blv" >
            <div class="friend_title col-sm-12">
                 {% if user_info.id ==session.get('userinfo')['id'] %}
                    我的好友
                 {%else%}
                    他的好友
                {%endif%}
            </div>
            <div class="col-sm-12 friend_content"></div>
        </div>
        <div class="col-sm-12 page-center">
            <ul class="sync-pagination pagination-sm" id="user-friend-pagination"></ul>
        </div>
    </div>
</div>


<link href="/try/bootstrap/twitter-bootstrap-v2/docs/assets/css/bootstrap.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="lib/bootstrap/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="stylesheets/community/user.css">

{%endif%}
</div>
<script src="lib/jquery.twbsPagination.min.js" type="text/javascript"></script>
<script src="lib/js/user.js" type="text/javascript"></script>
<script type="text/javascript">
//init data
var defaultPage=1;
var fPageNo=1;
var pageNo=1;
var pageSize=10,fPageSize = 10;
var totalPages=0,fTotalPages = 0;
var login_userid=0;

var user_id={{user_info.id}};
//load_more_friends(1)
var a = '<a  class="user_btn user_relation_btn" onclick="add_relation()">关注</a>'
{% if session.get('userinfo') %}
     login_userid={{session.get('userinfo')['id']}};
     if(login_userid!={{user_info.id}}){
       $('a.user_sendmsg_btn').before(select_relation());
     }
{%endif%}
load_friends(1);
load_post(1);
init();

// init end
function likeReply(replyId) {
   if(login_userid>0){
       var countElementId = "count-" + replyId;
       var linkElementId = "link-" + replyId;
       var isliked = $("#isliked-" + replyId).val();
       var modType = "";
       var count = $("#" + countElementId).text();
       // add by lxx
       if (count=="" || isNaN(parseInt(count))){
           count=0;
       }
       if (isliked == "True" || isliked=="true") {
           var countNum = parseInt(count) - 1;
           if(countNum==0){
             $("#" + countElementId).text("");
           }else{
            $("#" + countElementId).text("" + countNum);
            }
           $("#" + linkElementId).addClass("reply-liked-no");
           $("#isliked-" + replyId).val("False");
           modType="remove";
       } else {
           var countNum = parseInt(count) + 1;
           $("#" + countElementId).text("" + countNum);
           $("#" + linkElementId).removeClass("reply-liked-no");
           $("#isliked-" + replyId).val("True");
           modType="add";
       }

       var url = "/reply_like_status_change?replyid=" + replyId + "&modtype=" + modType;
       console.debug("isliked: ", isliked, "url: ", url);
       $.get(url, function(data) {
           console.debug("data:", data);
       });
    }else{
       alert("需要登陆才能点赞！");
    }

   }




function add_relation(){
    {% if session.get('userinfo') %}
        $.ajax({
             type:'POST',
             url:'/add_relation',
             data:{
                 relation_user_id:user_id,
                 is_relation:0
             },
             dataType:'json',
             success:function(data) {
                var a = '<a  class="user_btn user_relation_btn"  onclick="cancel_relation()">已关注</a>'
                $('a.user_relation_btn').remove();
                $('a.user_sendmsg_btn').before(a);
             },
             error:function(xhr,type){
                 alert('操作失败!');
             }
         })
    {%else%}
        alert('请先登录')
    {%endif%}
}
function cancel_relation(){
    if(login_userid>0){
        $.ajax({
             type:'POST',
             url:'/cancel_relation',
             data:{
                user_id:login_userid,
                relation_user_id:user_id
             },
             dataType:'json',
             success:function(data) {
                alert('您已取消关注！')
                var a = '<a  class="user_btn user_relation_btn" onclick="add_relation()">关注</a>'
                $('a.user_relation_btn').remove();
                $('a.user_sendmsg_btn').before(a);

             },
             error:function(xhr,type){
                 alert('操作失败!');
             }
         })
    }
}




function select_relation(){
    var a = '<a  class="user_btn user_relation_btn" onclick="add_relation()">关注</a>'
        if(login_userid>0){
             $.ajax({
                    type:'POST',
                    url:'/select_relation',
                    data:{
                        user_id:login_userid,
                        relation_user_id:user_id
                    },
                    async:false,
                    dataType:'json',
                    success:function(data) {
                        if(data.is_relation==1){
                            a = '<a  class="user_btn user_relation_btn" onclick="cancel_relation()">已关注</a>'
                        }
                    }
             })
        }
    return a;
}

function init(){
    if(totalPages>0){
        $('#user-post-pagination').twbsPagination({
           startPage: pageNo,
           totalPages: totalPages,
           first: '首页',
           prev: '前一页',
           next: '下一页',
           last: '末页',
           onPageClick: function (evt, page) {
               if (page == pageNo) {
                   console.debug("current page number clicked, do nothing.");
                   return;
               }
              load_post(page);
              window.location.hash="#user";//定位到列表头部
           }
        });
    }//post info end


    if(fTotalPages>0){
        // more friends start
        $('#user-friend-pagination').twbsPagination({
           startPage: fPageNo,
           totalPages: fTotalPages,
           first: '首页',
           prev: '前一页',
           next: '下一页',
           last: '末页',
           onPageClick: function (evt, page) {
               if (page == fPageNo) {
                   console.debug("current page number clicked, do nothing.");
                   return;
               }
               load_more_friends(page)
              window.location.hash="#user";//定位到列表头部


           }
        });
    }
}
</script>
{% endblock %}
